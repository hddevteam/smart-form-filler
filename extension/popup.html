<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Form Filler</title>
    <link rel="stylesheet" href="styles/popup.css">
</head>
<body>
    <div class="analyzer">
        <!-- Header -->
        <div class="analyzer__header">
            <div class="analyzer__brand">
                <img src="icons/icon32.png" alt="Smart Form Filler" class="analyzer__icon">
                <div class="analyzer__model-controls">
                    <select id="globalModelSelect" class="select select--header" title="Select AI Model" disabled>
                        <option value="">Loading models...</option>
                    </select>
                    <button id="globalRefreshModelsBtn" class="btn btn--header" title="Refresh Ollama models">
                        <span class="btn__icon">üîÑ</span>
                    </button>
                    <button id="settingsBtn" class="btn btn--header" title="Settings">
                        <span class="btn__icon">‚öôÔ∏è</span>
                    </button>
                </div>
            </div>
            <div class="analyzer__status" id="authStatus">
                <div class="status-indicator" id="authIndicator"></div>
                <span class="status-text" id="authText">Checking...</span>
            </div>
        </div>        <!-- Content -->
        <div class="analyzer__content">
            <!-- Main Navigation Tabs -->
            <div class="main-tabs">
                <button class="main-tab main-tab--active" data-tab="extraction">
                    <span class="main-tab__icon">üìä</span>
                    <span class="main-tab__text">Data Extraction</span>
                </button>
                <button class="main-tab" data-tab="chat">
                    <span class="main-tab__icon">üí¨</span>
                    <span class="main-tab__text">Chat with Data</span>
                </button>
                <button class="main-tab" data-tab="formfiller">
                    <span class="main-tab__icon">‚úçÔ∏è</span>
                    <span class="main-tab__text">Form Filler</span>
                </button>
            </div>

            <!-- Data Extraction Tab Content -->
            <div id="extractionTab" class="main-tab-content main-tab-content--active">
                <!-- Analysis Purpose Section -->
                <div class="section">
                    <div class="section__header">
                        <h3 class="section__title">Data Extraction</h3>
                        <p class="section__description">Extract structured data sources (Markdown + HTML)</p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="section">
                    <div class="section__content">
                        <div class="action-buttons action-buttons--single-button">
                            <button id="extractDataBtn" class="btn btn--primary btn--large">
                                <span class="btn__icon">üìä</span>
                                <span class="btn__text">Extract Data Sources</span>
                            </button>
                            <button id="loginBtn" class="btn btn--tertiary hidden">
                                <span class="btn__icon">üîê</span>
                                <span class="btn__text">Sign In</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="section hidden">
                    <div class="section__header">
                        <h3 class="section__title">Extraction History</h3>
                        <div class="results-actions-header">
                            <button id="clearAllBtn" class="btn btn--tertiary btn--small">
                                <span class="btn__icon">üóëÔ∏è</span>
                                Clear All
                            </button>
                        </div>
                    </div>
                    <div class="section__content">
                        <!-- History List Container -->
                        <div id="historyContainer" class="history-container">
                            <!-- Dynamic history items will be inserted here -->
                        </div>
                        
                        <!-- Current Results Detail View (Hidden by default) -->
                        <div id="currentResultsDetail" class="results-detail hidden">
                            <div class="results-container">
                                <div class="results-tabs">
                                    <button class="results-tab results-tab--active" data-tab="markdown" id="markdownTab">Markdown</button>
                                    <button class="results-tab" data-tab="html" id="htmlTab">Raw HTML</button>
                                    <button class="results-tab" data-tab="cleaned-html" id="cleanedHtmlTab">Cleaned HTML</button>
                                    <button class="results-tab" data-tab="metadata" id="metadataTab">Metadata</button>
                                </div>
                                <div class="results-content">
                                    <div class="results-panel results-panel--active" id="markdownPanel">
                                        <div class="results-text" id="markdownText"></div>
                                    </div>
                                    <div class="results-panel" id="htmlPanel">
                                        <div class="results-text" id="htmlText"></div>
                                    </div>
                                    <div class="results-panel" id="cleanedHtmlPanel">
                                        <div class="results-text" id="cleanedHtmlText"></div>
                                    </div>
                                    <div class="results-panel" id="metadataPanel">
                                        <pre class="results-code" id="metadataData"></pre>
                                    </div>
                                </div>
                                <div class="results-actions">
                                    <button id="copyBtn" class="btn btn--secondary btn--small">
                                        <span class="btn__icon">üìã</span>
                                        Copy Results
                                    </button>
                                    <button id="chatBtn" class="btn btn--primary btn--small">
                                        <span class="btn__icon">üí¨</span>
                                        Switch to Chat
                                    </button>
                                    <button id="backToHistoryBtn" class="btn btn--tertiary btn--small">
                                        <span class="btn__icon">‚Üê</span>
                                        Back to List
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat with Data Tab Content -->
            <div id="chatTab" class="main-tab-content">
                <!-- Data Source Selection Section -->
                <div class="section">
                    <div class="section__header section__header--with-action">
                        <div>
                            <h3 class="section__title">Data Sources</h3>
                            <p class="section__description">Configure your chat data sources</p>
                        </div>
                        <button id="openDataSourceModalBtn" class="btn btn--secondary btn--small">
                            <span class="btn__icon">‚öôÔ∏è</span>
                            <span class="btn__text">Configure Sources</span>
                        </button>
                    </div>
                    <div class="section__content">
                        <div class="data-source-summary">
                            <div class="data-source-summary__info">
                                <span id="dataSourceSummaryText">Selected: 0 sources, No type selected</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Messages Section -->
                <div class="section section--chat-container">
                    <div class="section__header section__header--with-action">
                        <div>
                            <h3 class="section__title">Chat Messages</h3>
                        </div>
                        <button id="clearChatBtn" class="btn btn--tertiary btn--small">
                            <span class="btn__icon">üóëÔ∏è</span>
                            <span class="btn__text">Clear Chat</span>
                        </button>
                    </div>
                    <div class="section__content section__content--chat">
                        <!-- Chat Messages -->
                        <div id="chatMessages" class="chat-messages">
                            <div class="chat-welcome">
                                <div class="chat-welcome__icon">üí¨</div>
                                <div class="chat-welcome__title">Start chatting with your data</div>
                                <div class="chat-welcome__description">
                                    Click "Configure Sources" to select data sources, then ask questions about the content.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Input - Fixed at bottom -->
                    <div class="chat-input-container">
                        <div class="chat-input">
                            <textarea id="chatInput" class="chat-input__field" placeholder="Ask a question about the selected data sources..." rows="2"></textarea>
                            <button id="sendChatBtn" class="chat-input__send" disabled>
                                <span class="btn__icon">‚Üí</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Filler Tab Content -->
            <div id="formFillerTab" class="main-tab-content">
                <!-- Content Input Section -->
                <div class="section">
                    <div class="section__header section__header--with-action">
                        <div>
                            <h3 class="section__title">Content to Fill</h3>
                            <p class="section__description">Enter content for AI-powered analysis and field mapping</p>
                        </div>
                        <div class="section__header-actions">
                            <select id="languageSelect" class="select select--primary select--compact" title="Select Output Language">
                                <option value="zh">Chinese</option>
                                <option value="en">English</option>
                            </select>
                            <button id="openFormFillerDataSourceModalBtn" class="btn btn--secondary btn--small">
                                <span class="btn__icon">‚öôÔ∏è</span>
                                <span class="btn__text">Configure Sources</span>
                            </button>
                        </div>
                    </div>
                    <div class="section__content">
                        <textarea id="fillContentInput" class="form-filler__input" placeholder="Example: Last weekend from 8 AM to 10 AM, the Network Information Department arranged for Zhang Ming to work overtime to handle an emergency incident." rows="4"></textarea>
                        
                        <!-- Data Source Summary for Form Filler -->
                        <div id="formFillerDataSourceSummary" class="data-source-summary hidden">
                            <div class="data-source-summary__info">
                                <span id="formFillerDataSourceSummaryText">Selected: 0 sources, No type selected</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Detection Section -->
                <div class="section">
                    <div class="section__header">
                        <h3 class="section__title">Form Detection</h3>
                        <p class="section__description">Detect forms on the current page</p>
                    </div>
                    <div class="section__content">
                        <div class="action-buttons action-buttons--form-detection">
                            <button id="detectFormsBtn" class="btn btn--secondary">
                                <span class="btn__icon">üîç</span>
                                <span class="btn__text">Detect Forms</span>
                            </button>
                        </div>
                        
                        <!-- Form Detection Results -->
                        <div id="formDetectionResults" class="form-detection-results hidden">
                            <div class="section__header section__header--collapsible section__header--results">
                                <div class="section__header-content">
                                    <div class="form-detection-summary">
                                        <span class="summary-item">
                                            <span class="summary-label">Forms Found:</span>
                                            <span class="summary-value" id="formsFoundCount">0</span>
                                        </span>
                                        <span class="summary-item">
                                            <span class="summary-label">Fields Found:</span>
                                            <span class="summary-value" id="fieldsFoundCount">0</span>
                                        </span>
                                        <span class="summary-item hidden" id="iframeStatsContainer">
                                            <span class="summary-label">Sources:</span>
                                            <span class="summary-value" id="sourceStats">Main + 0 iframes</span>
                                        </span>
                                    </div>
                                </div>
                                <button class="section__collapse-btn" data-target="formDetection" title="Collapse/Expand">
                                    <span class="collapse-icon">‚ñº</span>
                                </button>
                            </div>
                            
                            <div class="section__content--collapsible" data-section="formDetection">
                                <div id="formsList" class="forms-list">
                                    <!-- Dynamic form list will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Analysis Section -->
                <div id="analysisResultsSection" class="section hidden">
                    <div class="section__header section__header--collapsible">
                        <div class="section__header-content">
                            <h3 class="section__title">Content Analysis</h3>
                            <p class="section__description">Stage 1: Form relevance analysis</p>
                        </div>
                        <button class="section__collapse-btn" data-target="analysisResults" title="Collapse/Expand">
                            <span class="collapse-icon">‚ñº</span>
                        </button>
                    </div>
                    <div class="section__content section__content--collapsible" data-section="analysisResults">
                        <!-- Analyze Content Button - moved here -->
                        <div class="action-buttons action-buttons--content-analysis">
                            <button id="analyzeContentBtn" class="btn btn--primary" disabled>
                                <span class="btn__icon">üß†</span>
                                <span class="btn__text">Analyze Content</span>
                            </button>
                        </div>
                        
                        <div id="analysisResults" class="analysis-results">
                            <!-- Dynamic analysis results will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Field Mapping Section -->
                <div id="fieldMappingSection" class="section hidden">
                    <div class="section__header section__header--collapsible">
                        <div class="section__header-content">
                            <h3 class="section__title">Field Mapping</h3>
                            <p class="section__description">Stage 2: Generate detailed field mappings for the selected form</p>
                        </div>
                        <button class="section__collapse-btn" data-target="fieldMapping" title="Collapse/Expand">
                            <span class="collapse-icon">‚ñº</span>
                        </button>
                    </div>
                    <div class="section__content section__content--collapsible" data-section="fieldMapping">
                        <div class="action-buttons action-buttons--mapping">
                            <button id="generateMappingBtn" class="btn btn--primary" disabled>
                                <span class="btn__icon">üó∫Ô∏è</span>
                                <span class="btn__text">Generate Mapping</span>
                            </button>
                        </div>
                        
                        <div id="mappingResults" class="mapping-results hidden">
                            <!-- Dynamic mapping results will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Form Filling Actions -->
                <div id="fillActionsSection" class="section hidden">
                    <div class="section__header section__header--collapsible">
                        <div class="section__header-content">
                            <h3 class="section__title">Fill Forms</h3>
                            <p class="section__description">Apply the mapped data to form fields</p>
                        </div>
                        <button class="section__collapse-btn" data-target="fillActions" title="Collapse/Expand">
                            <span class="collapse-icon">‚ñº</span>
                        </button>
                    </div>
                    <div class="section__content section__content--collapsible" data-section="fillActions">
                        <div class="action-buttons action-buttons--fill-actions">
                            <button id="fillFormsBtn" class="btn btn--primary" disabled>
                                <span class="btn__icon">‚úçÔ∏è</span>
                                <span class="btn__text">Fill Forms</span>
                            </button>
                        </div>
                        
                        <div id="fillResults" class="fill-results hidden">
                            <!-- Dynamic fill results will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Clear All Section -->
                <div class="section">
                    <div class="section__header">
                        <h3 class="section__title">Reset</h3>
                        <p class="section__description">Clear all inputs and analysis results</p>
                    </div>
                    <div class="section__content">
                        <div class="action-buttons action-buttons--clear">
                            <button id="clearAllFormFillerBtn" class="btn btn--secondary btn--danger">
                                <span class="btn__icon">üóëÔ∏è</span>
                                <span class="btn__text">Clear All</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-overlay hidden">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Processing...</div>
                    <div class="loading-details" id="loadingDetails">Initializing</div>
                    <div class="loading-cancel-container">
                        <button id="cancelLoadingBtn" class="btn btn--secondary btn--small loading-cancel">
                            <span class="btn__icon">‚úï</span>
                            <span class="btn__text">Cancel</span>
                        </button>
                    </div>
                </div>
            </div>





            <!-- Error State -->
            <div id="errorState" class="error-container hidden">
                <div class="error-content">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-message" id="errorMessage"></div>
                    <button id="retryBtn" class="btn btn--secondary btn--small">
                        Try Again
                    </button>
                </div>
            </div>
        </div>
        <div class="analyzer__footer">
            <div class="footer-info">
                <span class="footer-version">v2.0.0</span>
                <span class="footer-separator">‚Ä¢</span>
                <span class="footer-mode" id="selectedMode">Data Extraction</span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal__backdrop"></div>
        <div class="modal__content">
            <div class="modal__header">
                <h3 class="modal__title">Settings</h3>
                <button id="settingsModalClose" class="btn btn--icon" title="Close">
                    <span class="btn__icon">√ó</span>
                </button>
            </div>
            <div class="modal__body">
                <div class="settings-section">
                    <h4 class="settings-section__title">Backend Configuration</h4>
                    <div class="form-group">
                        <label for="backendUrlInput" class="label">Backend URL:</label>
                        <div class="input-group">
                            <input 
                                type="text" 
                                id="backendUrlInput" 
                                class="input input--full" 
                                placeholder="http://localhost:3001"
                                value="http://localhost:3001"
                            >
                            <button id="testConnectionBtn" class="btn btn--secondary" title="Test Connection">
                                <span class="btn__icon">üîó</span>
                                <span class="btn__text">Test</span>
                            </button>
                        </div>
                        <div id="connectionStatus" class="connection-status hidden">
                            <span class="connection-status__icon"></span>
                            <span class="connection-status__text"></span>
                        </div>
                        <div class="help-text">
                            Enter the URL of your Smart Form Filler backend server.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button id="settingsCancelBtn" class="btn btn--secondary">Cancel</button>
                <button id="saveSettingsBtn" class="btn btn--primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Data Source Selection Modal -->
    <div id="dataSourceModal" class="modal hidden">
        <div class="modal__backdrop"></div>
        <div class="modal__content">
            <div class="modal__header">
                <h3 class="modal__title">Configure Data Sources</h3>
                <button id="dataSourceModalClose" class="btn btn--icon" title="Close">
                    <span class="btn__icon">√ó</span>
                </button>
            </div>
            <div class="modal__body">
                <!-- Data Source Type Selection -->
                <div class="data-source-section">
                    <h4 class="data-source-section__title">Data Source Type</h4>
                    <div class="data-source-type-options">
                        <label class="data-source-option">
                            <input type="radio" name="dataSourceType" value="markdown" checked>
                            <div class="data-source-option__content">
                                <div class="data-source-option__icon">üìù</div>
                                <div class="data-source-option__info">
                                    <div class="data-source-option__title">Markdown</div>
                                    <div class="data-source-option__description">Clean, formatted text ideal for Q&A</div>
                                </div>
                            </div>
                        </label>
                        <label class="data-source-option">
                            <input type="radio" name="dataSourceType" value="cleaned">
                            <div class="data-source-option__content">
                                <div class="data-source-option__icon">üßπ</div>
                                <div class="data-source-option__info">
                                    <div class="data-source-option__title">Cleaned HTML</div>
                                    <div class="data-source-option__description">Structured HTML with enhanced formatting</div>
                                </div>
                            </div>
                        </label>
                        <label class="data-source-option">
                            <input type="radio" name="dataSourceType" value="raw">
                            <div class="data-source-option__content">
                                <div class="data-source-option__icon">üîß</div>
                                <div class="data-source-option__info">
                                    <div class="data-source-option__title">Raw HTML</div>
                                    <div class="data-source-option__description">Complete page source including all elements</div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Data Source Selection -->
                <div class="data-source-section">
                    <h4 class="data-source-section__title">Available Data Sources</h4>
                    <div id="dataSourceList" class="data-source-list">
                        <div class="data-source-empty">
                            <div class="data-source-empty__icon">üìä</div>
                            <div class="data-source-empty__text">No data sources available</div>
                            <div class="data-source-empty__description">
                                Switch to the Data Extraction tab and extract some content first.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button id="dataSourceCancelBtn" class="btn btn--secondary">Cancel</button>
                <button id="dataSourceApplyBtn" class="btn btn--primary">Apply Selection</button>
            </div>
        </div>
    </div>

    <!-- Scripts - Load modules in order -->
    <script src="src/auth/authManager.js"></script>
    <script src="src/api/apiClient.js"></script>
    
    <!-- Load modules -->
    <script src="src/modules/dataExtractor.js"></script>
    <script src="src/modules/resultsHandler.js"></script>
    <script src="src/modules/chatHandler.js"></script>
    <script src="src/modules/copyHandler.js"></script>
    <script src="src/modules/uiController.js"></script>
    <!-- Form Filler Module Dependencies -->
    <script src="src/modules/formUtils.js"></script>
    <script src="src/modules/formDetectionService.js"></script>
    <script src="src/modules/formAnalysisService.js"></script>
    <script src="src/modules/formUIController.js"></script>
    <script src="src/modules/collapsibleManager.js"></script>
    <script src="src/modules/formFillerHandler.js"></script>
    
    <!-- Popup manager modules -->
    <script src="src/modules/popupInitializer.js"></script>
    <script src="src/modules/popupEventHandlers.js"></script>
    <script src="src/modules/popupModelManager.js"></script>
    <script src="src/modules/popupSettingsManager.js"></script>
    <script src="src/modules/popupDataSourceManager.js"></script>
    <script src="src/modules/popupManager.js"></script>
    
    <!-- Main popup manager -->
    <script src="src/popup-main.js"></script>
    
    <!-- Fallback error handler -->
    <script>
        // Global error handler to catch any uncaught errors
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
            console.error('Error details:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                stack: e.error ? e.error.stack : 'No stack trace'
            });
            
            // Show error in UI if possible
            const body = document.body;
            if (body && !document.querySelector('.global-error-display')) {
                body.insertAdjacentHTML('beforeend', `
                    <div class="global-error-display" style="position: fixed; top: 0; left: 0; right: 0; z-index: 10000; background: #ff4444; color: white; padding: 10px; font-family: monospace; font-size: 12px;">
                        <strong>JavaScript Error:</strong> ${e.message}<br>
                        <strong>File:</strong> ${e.filename}:${e.lineno}:${e.colno}<br>
                        <button onclick="this.parentElement.remove()" style="float: right; background: white; color: black; border: none; padding: 2px 5px;">√ó</button>
                    </div>
                `);
            }
        });
        
        // Fallback initialization if DOMContentLoaded fails
        setTimeout(function() {
            if (!window.popupManager) {
                console.warn('‚ö†Ô∏è PopupManager not initialized after 2 seconds, attempting fallback...');
                try {
                    window.popupManager = new PopupManager();
                } catch (error) {
                    console.error('‚ùå Fallback initialization also failed:', error);
                }
            }
        }, 2000);
    </script>
</body>
</html>
