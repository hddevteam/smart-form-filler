<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰©å±•ä¿®å¤éªŒè¯</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            line-height: 1.6;
        }
        .status-card { 
            background: #f8f9fa; 
            border-left: 4px solid #007cba;
            padding: 15px; 
            margin: 15px 0;
        }
        .error { border-left-color: #dc3545; background: #fff5f5; }
        .success { border-left-color: #28a745; background: #f8fff9; }
        .warning { border-left-color: #ffc107; background: #fffcf5; }
        .test-btn {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-btn:hover { background: #005a87; }
        .log-area {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ› ï¸ Smart Form Filler ä¿®å¤éªŒè¯</h1>
    
    <div class="status-card">
        <h3>ğŸ¯ ä¿®å¤çš„é—®é¢˜</h3>
        <ul>
            <li>âœ… è¯­æ³•é”™è¯¯ï¼š<code>formDetectionService.js:61:55</code></li>
            <li>âœ… æœªå®šä¹‰é”™è¯¯ï¼š<code>FormDetectionService is not defined</code></li>
            <li>âœ… Chrome API é”™è¯¯ï¼š<code>onMessage</code> ç©ºå¼•ç”¨</li>
            <li>âœ… è®¤è¯çŠ¶æ€å¡åœ¨ "Checking..." ä¸æ›´æ–°</li>
            <li>âœ… ç³»ç»ŸæŒ‰é’®è¢«é”™è¯¯ç¦ç”¨</li>
        </ul>
    </div>

    <div class="status-card warning">
        <h3>âš ï¸ é¢„æœŸç»“æœ</h3>
        <ul>
            <li>æ‰©å±•å¼¹çª—åº”æ˜¾ç¤º "Ready" è€Œä¸æ˜¯ "Checking..."</li>
            <li>è®¾ç½®æŒ‰é’®å’Œåˆ·æ–°æŒ‰é’®åº”å§‹ç»ˆå¯ç”¨</li>
            <li>æ¨¡å‹é€‰æ‹©å™¨åº”èƒ½æ­£å¸¸åŠ è½½æ¨¡å‹åˆ—è¡¨</li>
            <li>æ•°æ®æºé…ç½®æŒ‰é’®åº”å¯ç”¨</li>
            <li>æµè§ˆå™¨æ§åˆ¶å°ä¸åº”æœ‰JavaScripté”™è¯¯</li>
        </ul>
    </div>

    <div class="status-card">
        <h3>ğŸ§ª æµ‹è¯•å·¥å…·</h3>
        <button class="test-btn" onclick="openExtension()">æ‰“å¼€æ‰©å±•å¼¹çª—</button>
        <button class="test-btn" onclick="checkBackend()">æ£€æŸ¥åç«¯çŠ¶æ€</button>
        <button class="test-btn" onclick="checkLogs()">æ£€æŸ¥é”™è¯¯æ—¥å¿—</button>
        <button class="test-btn" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <div id="results"></div>
    <div id="logs" class="log-area"></div>

    <div class="status-card success">
        <h3>ğŸ“‹ éªŒè¯æ¸…å•</h3>
        <p>æ‰“å¼€æ‰©å±•å¼¹çª—åï¼Œè¯·éªŒè¯ï¼š</p>
        <ol>
            <li>è®¤è¯çŠ¶æ€æ˜¾ç¤º "Ready" (ç»¿è‰²æŒ‡ç¤ºå™¨)</li>
            <li>è®¾ç½®æŒ‰é’® (âš™ï¸) å¯ä»¥ç‚¹å‡»</li>
            <li>åˆ·æ–°æ¨¡å‹æŒ‰é’® (ğŸ”„) å¯ä»¥ç‚¹å‡»</li>
            <li>æ¨¡å‹é€‰æ‹©å™¨ä¸æ˜¾ç¤º "Loading models..." æˆ– "Service unavailable"</li>
            <li>æ•°æ®æºé…ç½®æŒ‰é’®å¯ä»¥ç‚¹å‡»</li>
            <li>æ§åˆ¶å°æ²¡æœ‰çº¢è‰²é”™è¯¯ä¿¡æ¯</li>
        </ol>
    </div>

    <script>
        let logArea = document.getElementById('logs');
        let resultsArea = document.getElementById('results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logArea.textContent += logEntry;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function showResult(title, content, type = 'info') {
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            resultsArea.innerHTML += `
                <div class="status-card ${className}">
                    <h4>${title}</h4>
                    <div>${content}</div>
                </div>
            `;
        }

        function openExtension() {
            log('æ‰“å¼€æ‰©å±•å¼¹çª—...');
            try {
                const popup = window.open('http://localhost:8080/popup.html', 'extension', 'width=400,height=600,scrollbars=yes');
                if (popup) {
                    log('âœ… æ‰©å±•å¼¹çª—å·²æ‰“å¼€', 'success');
                    showResult('âœ… æ‰©å±•å·²æ‰“å¼€', 'è¯·æ£€æŸ¥å¼¹çª—ä¸­çš„è®¤è¯çŠ¶æ€å’ŒæŒ‰é’®çŠ¶æ€', 'success');
                    
                    // æ£€æŸ¥å¼¹çª—æ˜¯å¦æ­£å¸¸åŠ è½½
                    setTimeout(() => {
                        try {
                            if (!popup.closed && popup.document) {
                                log('ğŸ” æ£€æŸ¥å¼¹çª—çŠ¶æ€...', 'info');
                                const authText = popup.document.getElementById('authText');
                                const settingsBtn = popup.document.getElementById('settingsBtn');
                                const refreshBtn = popup.document.getElementById('globalRefreshModelsBtn');
                                
                                if (authText) {
                                    log(`è®¤è¯çŠ¶æ€: ${authText.textContent}`, 
                                        authText.textContent === 'Ready' ? 'success' : 'error');
                                }
                                if (settingsBtn) {
                                    log(`è®¾ç½®æŒ‰é’®çŠ¶æ€: ${settingsBtn.disabled ? 'ç¦ç”¨' : 'å¯ç”¨'}`, 
                                        settingsBtn.disabled ? 'error' : 'success');
                                }
                                if (refreshBtn) {
                                    log(`åˆ·æ–°æŒ‰é’®çŠ¶æ€: ${refreshBtn.disabled ? 'ç¦ç”¨' : 'å¯ç”¨'}`, 
                                        refreshBtn.disabled ? 'error' : 'success');
                                }
                            }
                        } catch (error) {
                            log(`æ£€æŸ¥å¼¹çª—çŠ¶æ€æ—¶å‡ºé”™: ${error.message}`, 'error');
                        }
                    }, 2000);
                    
                } else {
                    throw new Error('æ— æ³•æ‰“å¼€å¼¹çª—');
                }
            } catch (error) {
                log(`âŒ æ‰“å¼€æ‰©å±•å¤±è´¥: ${error.message}`, 'error');
                showResult('âŒ æ‰“å¼€å¤±è´¥', error.message, 'error');
            }
        }

        async function checkBackend() {
            log('æ£€æŸ¥åç«¯çŠ¶æ€...');
            try {
                const response = await fetch('http://localhost:3001/api/extension/models');
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… åç«¯è¿è¡Œæ­£å¸¸', 'success');
                    log(`æ¨¡å‹æ•°é‡: ${data.models?.length || 0}`);
                    showResult('âœ… åç«¯æ­£å¸¸', 
                        `åç«¯è¿è¡Œæ­£å¸¸ï¼Œå…±æœ‰ ${data.models?.length || 0} ä¸ªå¯ç”¨æ¨¡å‹`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                log(`âŒ åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                showResult('âŒ åç«¯è¿æ¥å¤±è´¥', 
                    `æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ (http://localhost:3001): ${error.message}`, 'error');
            }
        }

        function checkLogs() {
            log('æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—...');
            // åœ¨å®é™…æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªåŠŸèƒ½ä¼šè¢«é™åˆ¶
            // è¿™é‡Œä¸»è¦æ˜¯æé†’ç”¨æˆ·æ‰‹åŠ¨æ£€æŸ¥
            showResult('ğŸ“‹ æ£€æŸ¥æ§åˆ¶å°', 
                'è¯·æ‰‹åŠ¨æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12) æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯', 'warning');
        }

        function clearLogs() {
            logArea.textContent = '';
            resultsArea.innerHTML = '';
            log('æ—¥å¿—å·²æ¸…é™¤');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            log('å¼€å§‹è‡ªåŠ¨æ£€æŸ¥...');
            checkBackend();
        });

        // é”™è¯¯ç›‘å¬
        window.addEventListener('error', (event) => {
            log(`âŒ JavaScripté”™è¯¯: ${event.message} (${event.filename}:${event.lineno})`, 'error');
        });
    </script>
</body>
</html>
